<div class="dettaglio-container" [class.dark-mode]="(themeService.isDarkMode$ | async) ?? false"
  [class.sidebar-collapsed]="sidebarService.value">

  <main class="main-content">

    <div class="header">
      <button class="btn btn-secondary" (click)="tornaIndietro()">
        <fa-icon [icon]="faArrowLeft"></fa-icon>
        Torna ai clienti
      </button>

      <button class="btn btn-warning" (click)="modificaCliente()">
        <fa-icon [icon]="faEdit"></fa-icon>
        Modifica
      </button>
    </div>

    @if (cliente) {

    <div class="cliente-hero" [ngClass]="sessoClass">
      <div class="dettaglio-avatar">
        {{ cliente.nome[0] }}{{ cliente.cognome[0] }}
      </div>
      <div class="hero-info">
        <h1 class="dettaglio-nome">{{ cliente.nome }} {{ cliente.cognome }}</h1>
        <p class="hero-email">{{ cliente.email || 'Email non disponibile' }}</p>
      </div>
      <span class="badge-large">{{ cliente.sesso }}</span>
    </div>

    <nav class="dettaglio-nav">
      @for (item of navItems; track item.id) {
      <button class="nav-item" [class.active]="isActiveRoute(item.route)" (click)="navigaTo(item.route)">
        <fa-icon [icon]="item.icon"></fa-icon>
        <span class="label">
          {{ item.label }}
          @if (item.route === 'misurazioni' && haNuoveMisurazioni) {
          <span class="notification-dot"></span>
          }
        </span>
      </button>
      }
    </nav>

    @if (vistaCorrente === 'info') {
    <div class="dettaglio-grid layout-info">
      <div class="dettaglio-section medical-card">
        <h4><fa-icon [icon]="faUser"></fa-icon> Informazioni Anagrafiche</h4>
        <div class="medical-rows">
          <div class="medical-row">
            <div class="row-label"><fa-icon [icon]="faEnvelope"></fa-icon> Email</div>
            <div class="row-value">{{ cliente.email || 'N/D' }}</div>
          </div>
          <div class="medical-row">
            <div class="row-label"><fa-icon [icon]="faPhone"></fa-icon> Telefono</div>
            <div class="row-value">{{ cliente.telefono || 'N/D' }}</div>
          </div>
          <div class="medical-row">
            <div class="row-label"><fa-icon [icon]="faCalendar"></fa-icon> Data nascita</div>
            <div class="row-value">{{ formatData(cliente.dataNascita) }}</div>
          </div>
          <div class="medical-row">
            <div class="row-label"><fa-icon [icon]="faIdCard"></fa-icon> Età</div>
            <div class="row-value">{{ calcolaEta(cliente.dataNascita) }}</div>
          </div>
        </div>
      </div>

      <div class="dettaglio-section medical-card">
        <h4><fa-icon [icon]="faRunning"></fa-icon> Dati Fisici</h4>
        <div class="medical-rows">
          <div class="medical-row">
            <div class="row-label"><fa-icon [icon]="faWeight"></fa-icon> Peso</div>
            <div class="row-value">{{ cliente.peso ? (cliente.peso + ' kg') : 'N/D' }}</div>
          </div>
          <div class="medical-row">
            <div class="row-label"><fa-icon [icon]="faRuler"></fa-icon> Altezza</div>
            <div class="row-value">{{ cliente.altezza ? (cliente.altezza + ' cm') : 'N/D' }}</div>
          </div>
        </div>
        @if (bmi !== null && bmiCategoria !== null) {
        <div class="bmi-card" [attr.data-cat]="bmiCategoria.key">
          <div class="bmi-top">
            <div class="bmi-title">BMI</div>
            <div class="bmi-pill">
              <span class="bmi-value">{{ bmi }}</span>
              <span class="bmi-label">{{ bmiCategoria.label }}</span>
            </div>
          </div>
          <div class="bmi-bar" aria-label="Indicatore BMI">
            <div class="bmi-seg under" title="Sottopeso"></div>
            <div class="bmi-seg normal" title="Normopeso"></div>
            <div class="bmi-seg over" title="Sovrappeso"></div>
            <div class="bmi-seg obese" title="Obesità"></div>
            <div class="bmi-marker" [style.left.%]="bmiPercent"></div>
          </div>
          <div class="bmi-legend"><span>18.5</span><span>25</span><span>30</span></div>
        </div>
        } @else {
        <div class="bmi-missing">Inserisci peso e altezza per calcolare il BMI.</div>
        }
      </div>

      <div class="dettaglio-section full-width">
        <h4><fa-icon [icon]="faHeartbeat"></fa-icon> Informazioni Sanitarie</h4>
        <p>{{ cliente.problematicheSalutari || 'Nessuna informazione sanitaria registrata.' }}</p>
      </div>
    </div>
    }

    @if (vistaCorrente === 'nuova-misurazione') {
    <app-misurazione [clienteId]="clienteId" [cliente]="cliente"
      [isDarkMode]="(themeService.isDarkMode$ | async) ?? false" (misurazioneSalvata)="onMisurazioneSalvata()">
    </app-misurazione>
    }

    @if (vistaCorrente === 'misurazioni') {
    <app-lista-misurazioni [clienteId]="clienteId" [cliente]="cliente"
      [isDarkMode]="(themeService.isDarkMode$ | async) ?? false">
    </app-lista-misurazioni>
    }

    @if (vistaCorrente === 'plicometria') {
    <app-plicometria [clienteId]="clienteId" [isDarkMode]="(themeService.isDarkMode$ | async) ?? false"></app-plicometria>
    }



    @if (vistaCorrente === 'piano-alimentare') {

    <!-- MODALITÀ MODIFICA FULL SCREEN -->
    @if (schedaSelezionataId) {
    <div class="dettaglio-scheda-full">
      <div class="back-bar">
        <button class="btn-text" (click)="tornaAllaLista()">
          <fa-icon [icon]="faArrowLeft"></fa-icon>
          Torna allo storico diete
        </button>
      </div>

      <app-scheda-dieta [clienteId]="clienteId" [schedaId]="schedaSelezionataId"
        [isDarkMode]="(themeService.isDarkMode$ | async) ?? false">
      </app-scheda-dieta>
    </div>
    } @else {

    <!-- LAYOUT MASTER-DETAIL (Lista + Anteprima) -->
    <div class="master-detail-layout has-preview">
      <div class="master-panel">
        <app-lista-schede [clienteId]="clienteId" [isDarkMode]="(themeService.isDarkMode$ | async) ?? false"
          (schedaPreview)="onPreviewScheda($event)" (schedaSelected)="onSchedaSelezionata($event)"
          (createNew)="onRichiestaNuovaScheda()">
        </app-lista-schede>
      </div>

      <div class="detail-panel">
        @if (schedaPreview) {
        <app-anteprima-scheda [scheda]="schedaPreview" [isDarkMode]="(themeService.isDarkMode$ | async) ?? false"
          (editRequested)="onSchedaSelezionata(schedaPreview)" (closeRequested)="chiudiPreview()">
        </app-anteprima-scheda>
        } @else {
        <!-- EMPTY STATE -->
        <div class="empty-state-panel" [class.dark-mode]="(themeService.isDarkMode$ | async) ?? false">
          <div class="empty-state-icon">
            <fa-icon [icon]="faClipboardList"></fa-icon>
          </div>
          <h4>Nessuna scheda selezionata</h4>
          <p>Seleziona una scheda dalla lista per visualizzarne l'anteprima</p>
        </div>
        }
      </div>
    </div>
    }
    }

    }
  </main>
</div>