<div class="scheda-dieta-container" [class.dark-mode]="isDarkMode">
    <div class="header-section">
        <h2>
            <fa-icon [icon]="icons.book"></fa-icon>
            Scheda Dieta Personalizzata
        </h2>
        <div class="header-actions">
            <button class="btn-primary" (click)="onSalvaScheda()" [disabled]="saving || !schedaId">
                <fa-icon [icon]="icons.save"></fa-icon>
                {{ saving ? 'Salvataggio...' : 'Salva Scheda' }}
            </button>
        </div>
    </div>

    @if (errorMessage) {
    <div class="alert alert-danger">{{ errorMessage }}</div>
    }

    @if (successMessage) {
    <div class="alert alert-success">{{ successMessage }}</div>
    }

    <div class="content-layout">
        <section class="list-section">
            @if (loading) {
            <div class="text-center p-4">
                <div class="spinner-border" role="status">...</div>
            </div>
            }
            @if (!loading) {
            <div class="pasti-container">
                @for (pasto of pasti; track pasto.nome) {
                <div class="pasto-card" [class.expanded]="pastoEspanso === pasto.nome">

                    <div class="pasto-header" (click)="togglePasto(pasto.nome)">
                        <div class="pasto-info">
                            <div class="pasto-icon">
                                <fa-icon [icon]="getIconaPasto(pasto.nome)"></fa-icon>
                            </div>
                            <div class="pasto-details">
                                <h3>{{ pasto.nome }}</h3>
                                <span class="pasto-orario">
                                    @if (pasto.orarioInizio && pasto.orarioFine) {
                                    {{ pasto.orarioInizio | slice:0:5 }} - {{ pasto.orarioFine | slice:0:5 }}
                                    } @else {
                                    Orario non impostato
                                    }
                                </span>
                            </div>
                        </div>
                        <div class="pasto-stats">
                            <div class="stat-badge">
                                <span class="stat-value">{{ pasto.alimentiPasto?.length || 0 }}</span>
                                <span class="stat-label">alimenti</span>
                            </div>
                            <div class="stat-badge calories">
                                <span class="stat-value">{{ calcolaTotaleCalorico(pasto) }}</span>
                                <span class="stat-label">kcal</span>
                            </div>
                            <span class="chev">
                                <fa-icon
                                    [icon]="pastoEspanso === pasto.nome ? icons.chevronDown : icons.chevronRight"></fa-icon>
                            </span>
                        </div>
                    </div>

                    @if (pastoEspanso === pasto.nome) {
                    <div class="pasto-body">

                        <div class="orari-section">
                            <div class="orario-group">
                                <label>Inizio</label>
                                <input type="time" [(ngModel)]="pasto.orarioInizio" (change)="onSalvaOrariPasto(pasto)"
                                    class="time-input" />
                            </div>
                            <div class="orario-group">
                                <label>Fine</label>
                                <input type="time" [(ngModel)]="pasto.orarioFine" (change)="onSalvaOrariPasto(pasto)"
                                    class="time-input" />
                            </div>
                        </div>

                        <div class="alimenti-section">
                            <div class="section-title-inline">
                                <fa-icon [icon]="icons.apple"></fa-icon>
                                Alimenti Selezionati
                            </div>

                            @if (pasto.alimentiPasto && pasto.alimentiPasto.length > 0) {
                            <div class="alimenti-list">
                                @for (alimentoPasto of pasto.alimentiPasto; track $index) {
                                <div class="alimento-node">
                                    <div class="alimento-item">
                                        <div class="alimento-info">
                                            <span class="alimento-nome">{{ alimentoPasto.alimento.nome }}</span>
                                            <div class="macros-mini">
                                                <span class="macro p">P: {{ calcolaMacro(alimentoPasto, 'proteine') |
                                                    number:'1.0-2'}} g</span>
                                                <span class="macro c">C: {{ calcolaMacro(alimentoPasto, 'carboidrati') |
                                                    number:'1.0-2'}} g</span>
                                                <span class="macro g">G: {{ calcolaMacro(alimentoPasto, 'grassi') |
                                                    number:'1.0-2'}} g</span>
                                                <span class="macro kcal">{{ calcolaMacro(alimentoPasto, 'calorie') |
                                                    number:'1.0-0'}} kcal</span>
                                            </div>
                                        </div>

                                        <div class="alimento-quantita">
                                            <input type="number" [ngModel]="alimentoPasto.quantita" #qtyInput
                                                (change)="onAggiornaQuantita(pasto, alimentoPasto.alimento.id ?? 0, qtyInput.valueAsNumber)"
                                                min="1" class="quantita-input" />
                                            <span class="unit">g</span>
                                        </div>

                                        <button class="icon-btn danger" type="button"
                                            (click)="onRimuoviAlimento(pasto, alimentoPasto.alimento.id ?? 0)"
                                            title="Rimuovi">
                                            <fa-icon [icon]="icons.trash"></fa-icon>
                                        </button>
                                    </div>

                                    <div class="alternatives">
                                        <div class="alternatives-row">
                                            @for (slot of alternativeSlots; track slot) {
                                            <div class="alternative-card">
                                                @if (getAlternative(alimentoPasto.id, slot); as alt) {
                                                <div class="alternative-header">
                                                    <span class="alternative-title">{{ alt.alimento.nome }}</span>
                                                    <div class="alternative-actions">
                                                        <button class="icon-btn" type="button"
                                                            (click)="startAlternativeEdit(alimentoPasto, slot)"
                                                            title="Modifica">
                                                            <fa-icon [icon]="icons.edit"></fa-icon>
                                                        </button>
                                                        <button class="icon-btn danger" type="button"
                                                            (click)="removeAlternative(alimentoPasto.id, slot)"
                                                            title="Elimina">
                                                            <fa-icon [icon]="icons.trash"></fa-icon>
                                                        </button>
                                                    </div>
                                                </div>
                                                <div class="alternative-controls">
                                                    <div class="alternative-qty-row">
                                                        <input class="alternative-qty-input" type="number" min="1"
                                                            [ngModel]="alt.quantita" #altQtyInput
                                                            (change)="updateAlternativeQuantity(alimentoPasto.id, slot, altQtyInput.valueAsNumber)" />
                                                        <span class="alternative-qty-unit">g</span>
                                                    </div>
                                                    <select class="alternative-mode-select" [ngModel]="alt.mode"
                                                        (ngModelChange)="updateAlternativeMode(alimentoPasto, slot, $event)">
                                                        <option value="calorie">Kcal</option>
                                                        <option value="proteine">Proteine</option>
                                                        <option value="carboidrati">Carboidrati</option>
                                                        <option value="grassi">Grassi</option>
                                                    </select>
                                                    <button class="alternative-auto-btn" type="button"
                                                        (click)="resetAlternativeQuantity(alimentoPasto, slot)"
                                                        title="Ricalcola suggerimento">
                                                        Auto
                                                    </button>
                                                    @if (alt.manual) {
                                                    <span class="alternative-badge">Manuale</span>
                                                    }
                                                </div>
                                                <div class="macros-mini alternative-macros">
                                                    <span class="macro p">{{ calcolaMacroDaAlimento(alt.alimento,
                                                        alt.quantita, 'proteine') |
                                                        number:'1.0-2'}} g</span>
                                                    <span class="macro c">{{ calcolaMacroDaAlimento(alt.alimento,
                                                        alt.quantita, 'carboidrati') |
                                                        number:'1.0-2'}} g</span>
                                                    <span class="macro g">{{ calcolaMacroDaAlimento(alt.alimento,
                                                        alt.quantita, 'grassi') |
                                                        number:'1.0-2'}} g</span>
                                                    <span class="macro kcal">{{ calcolaMacroDaAlimento(alt.alimento,
                                                        alt.quantita, 'calorie') |
                                                        number:'1.0-0'}} kcal</span>
                                                </div>
                                                } @else {
                                                @if (getAlternativeUi(alimentoPasto.id, slot).editing) {
                                                <div class="alternative-editor">
                                                    <div class="alternative-input-row">
                                                        <input class="alternative-input" type="text"
                                                            [ngModel]="getAlternativeUi(alimentoPasto.id, slot).query"
                                                            (ngModelChange)="onAlternativeQueryChange(alimentoPasto, slot, $event)"
                                                            placeholder="Cerca alternativa..." />
                                                        <button class="icon-btn" type="button"
                                                            (click)="closeAlternativeEdit(alimentoPasto.id, slot)"
                                                            title="Chiudi">
                                                            <fa-icon [icon]="icons.close"></fa-icon>
                                                        </button>
                                                    </div>

                                                    @if (getAlternativeUi(alimentoPasto.id, slot).loading) {
                                                    <div class="alternative-loading">Caricamento...</div>
                                                    }

                                                    @if (!getAlternativeUi(alimentoPasto.id, slot).loading &&
                                                    getAlternativeUi(alimentoPasto.id, slot).results.length > 0) {
                                                    <div class="alternative-results">
                                                        @for (res of getAlternativeUi(alimentoPasto.id, slot).results;
                                                        track res.id) {
                                                        <button class="alternative-result" type="button"
                                                            (click)="selectAlternative(alimentoPasto, slot, res)">
                                                            {{ res.nome }}
                                                        </button>
                                                        }
                                                    </div>
                                                    } @else if (!getAlternativeUi(alimentoPasto.id, slot).loading &&
                                                    (getAlternativeUi(alimentoPasto.id, slot).query || '').trim().length
                                                    >
                                                    0) {
                                                    <div class="alternative-empty">Nessun risultato</div>
                                                    }
                                                </div>
                                                } @else {
                                                <button class="alternative-add" type="button"
                                                    (click)="startAlternativeEdit(alimentoPasto, slot)">
                                                    <fa-icon [icon]="icons.plus"></fa-icon>
                                                    <span>Proponi alternativa</span>
                                                </button>
                                                }
                                                }
                                            </div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                }
                            </div>
                            } @else {
                            <div class="empty-alimenti">
                                <fa-icon [icon]="icons.apple"></fa-icon>
                                <span>Nessun alimento aggiunto. Cerca e aggiungi alimenti dalla sezione a destra.</span>
                            </div>
                            }

                            <div class="macro-totals">
                                <div class="macro-total-card">
                                    <span class="macro-label">Proteine</span>
                                    <span class="macro-value proteine">{{ calcolaTotaleMacro(pasto, 'proteine') |
                                        number:'1.0-2'}} g</span>
                                </div>
                                <div class="macro-total-card">
                                    <span class="macro-label">Carboidrati</span>
                                    <span class="macro-value carboidrati">{{ calcolaTotaleMacro(pasto, 'carboidrati') |
                                        number:'1.0-2'}} g</span>
                                </div>
                                <div class="macro-total-card">
                                    <span class="macro-label">Grassi</span>
                                    <span class="macro-value grassi">{{ calcolaTotaleMacro(pasto, 'grassi') |
                                        number:'1.0-2'}} g</span>
                                </div>
                                <div class="macro-total-card highlight">
                                    <span class="macro-label">Calorie</span>
                                    <span class="macro-value kcal">{{ calcolaTotaleCalorico(pasto) | number:'1.0-0'}}
                                        kcal</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    }
                </div>
                }
            </div>

            <div class="riepilogo-giornata">
                <div class="section-title-inline">
                    <fa-icon [icon]="icons.chart"></fa-icon>
                    Riepilogo Giornaliero
                </div>
                <div class="riepilogo-grid">
                    <div class="riepilogo-card">
                        <div class="riepilogo-icon proteine">
                            <fa-icon [icon]="icons.dumbbell"></fa-icon>
                        </div>
                        <div class="riepilogo-content">
                            <span class="riepilogo-value">{{ calcolaTotaleGiornaliero('proteine') | number:'1.0-2'}}
                                g</span>
                            <span class="riepilogo-label">Proteine</span>
                        </div>
                    </div>
                    <div class="riepilogo-card">
                        <div class="riepilogo-icon carboidrati">
                            <fa-icon [icon]="icons.wheat"></fa-icon>
                        </div>
                        <div class="riepilogo-content">
                            <span class="riepilogo-value">{{ calcolaTotaleGiornaliero('carboidrati') | number:'1.0-2'}}
                                g</span>
                            <span class="riepilogo-label">Carboidrati</span>
                        </div>
                    </div>
                    <div class="riepilogo-card">
                        <div class="riepilogo-icon grassi">
                            <fa-icon [icon]="icons.droplet"></fa-icon>
                        </div>
                        <div class="riepilogo-content">
                            <span class="riepilogo-value">{{ calcolaTotaleGiornaliero('grassi') | number:'1.0-2'}}
                                g</span>
                            <span class="riepilogo-label">Grassi</span>
                        </div>
                    </div>
                    <div class="riepilogo-card highlight">
                        <div class="riepilogo-icon kcal">
                            <fa-icon [icon]="icons.fire"></fa-icon>
                        </div>
                        <div class="riepilogo-content">
                            <span class="riepilogo-value">{{ calcolaTotaleCalorieGiornaliere() | number:'1.0-0'}}</span>
                            <span class="riepilogo-label">Calorie Totali</span>
                        </div>
                    </div>
                </div>
            </div>
            }
        </section>

        <app-catalogo-alimenti [pastoEspanso]="pastoEspanso" [schedaSalvata]="!!schedaId" [isDarkMode]="isDarkMode"
            (alimentoSelezionato)="onAggiungiAlimento($event)">
        </app-catalogo-alimenti>
    </div>
</div>