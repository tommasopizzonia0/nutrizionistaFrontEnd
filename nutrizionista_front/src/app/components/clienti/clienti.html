<div class="container" [class.dark-mode]="themeService.isDarkMode$ | async"
  [class.sidebar-collapsed]="sidebarService.value">

  <main class="main-content">

    <!-- HEADER -->
    <div class="header">
      <h1>
        <fa-icon [icon]="faUserGroup"></fa-icon>
        Gestione Clienti
      </h1>

      <button class="btn btn-primary" (click)="apriModalCreazione()">
        <fa-icon [icon]="faPlus"></fa-icon>
        Nuovo Cliente
      </button>
    </div>

    <div class="stats">
      <div class="stat-card">
        <div class="stat-icon">
          <fa-icon [icon]="faUserGroup"></fa-icon>
        </div>
        <div class="stat-info">
          <span class="stat-number">{{ totalElements }}</span>
          <small class="stat-label">Clienti Totali</small>
        </div>
      </div>

      <!-- SEARCH -->
      <div class="search-card" (click)="$event.stopPropagation()">
        <fa-icon class="search-icon" [icon]="faSearch"></fa-icon>
        <input type="text" class="search-input" placeholder="Cerca per nome..." [(ngModel)]="searchTerm"
          autocomplete="off" />
        @if (searchTerm.length) {
        <button class="search-clear" type="button" (click)="searchTerm=''; $event.stopPropagation()">
          <fa-icon [icon]="faTimes"></fa-icon>
        </button>
        }
      </div>
    </div>

    <!-- LISTA CLIENTI -->
    <div class="clienti-grid">
      @for (cliente of clientiFiltrati; track cliente.id) {
      <div class="cliente-card" (click)="visualizzaDettaglio(cliente.id!)">

        <div class="cliente-header">
          <div class="cliente-avatar">
            {{ cliente.nome[0] }}{{ cliente.cognome[0] }}
          </div>

          <div class="cliente-info">
            <h3>{{ cliente.nome }} {{ cliente.cognome }}</h3>
            <fa-icon class="meta-icon" [icon]="faCalendarAlt"></fa-icon>
            <span class="meta-value">
              {{ formatDataNascita(cliente.dataNascita) }}
            </span>
          </div>
        </div>


        <div class="cliente-actions" (click)="$event.stopPropagation()">
          <button (click)="apriModalModifica(cliente)">
            <fa-icon [icon]="faEdit"></fa-icon>
          </button>
          <button (click)="eliminaCliente(cliente.id!)">
            <fa-icon [icon]="faTrash"></fa-icon>
          </button>
        </div>
      </div>
      }
    </div>

    <!-- PAGINAZIONE -->
    @if (totalPages > 1) {
    <div class="pagination-pro">
      <button class="page-btn" (click)="cambiapagina(currentPage - 1)" [disabled]="currentPage === 0"
        aria-label="Pagina precedente">
        <fa-icon [icon]="faChevronLeft"></fa-icon>
      </button>

      <div class="page-indicator pill-indicator">
        <span class="page-current">{{ paginaCorrente }}</span>
        <span class="page-sep">/</span>
        <span class="page-total">{{ totalPages }}</span>
      </div>

      <button class="page-btn" (click)="cambiapagina(currentPage + 1)" [disabled]="currentPage === totalPages - 1"
        aria-label="Pagina successiva">
        <fa-icon [icon]="faChevronRight"></fa-icon>
      </button>
    </div>
    }


    <!-- MODAL -->
    @if (modalAperta) {
    <div class="modal-overlay" (click)="chiudiModal()">
      <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header-custom">
          <h2>
            <fa-icon [icon]="faUserPlus"></fa-icon>
            {{ isEdit ? 'Modifica Cliente' : 'Nuovo Cliente' }}
          </h2>
        </div>
        <div class="stepper">
          <button type="button" class="step" [class.active]="step===1"
            (click)="vaiStep(1)">1<br><small>Anagrafica</small></button>
          <button type="button" class="step" [class.active]="step===2"
            (click)="vaiStep(2)">2<br><small>Contatti</small></button>
          <button type="button" class="step" [class.active]="step===3" (click)="vaiStep(3)">3<br><small>Dati
              fisici</small></button>
          <button type="button" class="step" [class.active]="step===4" (click)="vaiStep(4)">4<br><small>Stile di
              vita</small></button>
          <button type="button" class="step" [class.active]="step===5" (click)="vaiStep(5)">5<br><small>Info
              mediche</small></button>
        </div>

        <form class="modal-body" (ngSubmit)="salvaCliente()">

          <!-- Dati Anagrafici -->
          @if (step === 1) {
          <div class="form-section">
            <h3><fa-icon [icon]="faIdCard"></fa-icon> Dati Anagrafici</h3>

            <div class="form-row">
              <div class="form-group">
                <label for="nome">Nome *</label>
                <input type="text" id="nome" name="nome" class="form-control" [(ngModel)]="nuovoCliente.nome" required
                  placeholder="Inserisci il nome">
              </div>

              <div class="form-group">
                <label for="cognome">Cognome *</label>
                <input type="text" id="cognome" name="cognome" class="form-control" [(ngModel)]="nuovoCliente.cognome"
                  required placeholder="Inserisci il cognome">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="sesso">Sesso *</label>
                <select id="sesso" name="sesso" class="form-control" [(ngModel)]="nuovoCliente.sesso" required>
                  <option value="MASCHIO">Maschio</option>
                  <option value="FEMMINA">Femmina</option>
                </select>
              </div>

              <div class="form-group">
                <label for="dataNascita">Data di Nascita *</label>
                <input type="date" id="dataNascita" name="dataNascita" class="form-control"
                  [(ngModel)]="nuovoCliente.dataNascita" required>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="codiceFiscale">Codice Fiscale *</label>
                <input type="text" id="codiceFiscale" name="codiceFiscale" class="form-control"
                  [(ngModel)]="nuovoCliente.codiceFiscale" maxlength="16" placeholder="RSSMRA80A01H501U">
              </div>
            </div>
          </div>
          }

          @if (step === 2) {
          <div class="form-section">
            <h3><fa-icon [icon]="faUserPlus"></fa-icon> Contatti</h3>

            <div class="form-row">
              <div class="form-group">
                <label for="email">Email *</label>
                <input type="email" id="email" name="email" class="form-control" [(ngModel)]="nuovoCliente.email"
                  placeholder="esempio@email.com">
              </div>

              <div class="form-group">
                <label for="telefono">Telefono *</label>
                <input type="tel" id="telefono" name="telefono" class="form-control" [(ngModel)]="nuovoCliente.telefono"
                  placeholder="+39 333 1234567">
              </div>
            </div>
          </div>
          }


          <!-- Dati Fisici -->
          @if (step === 3) {
          <div class="form-section">
            <h3><fa-icon [icon]="faHeartbeat"></fa-icon> Dati Fisici</h3>

            <div class="form-row">
              <div class="form-group">
                <label for="peso">Peso (kg) *</label>
                <input type="number" id="peso" name="peso" class="form-control" [(ngModel)]="nuovoCliente.peso" min="0"
                  step="0.1" placeholder="70.5">
              </div>

              <div class="form-group">
                <label for="altezza">Altezza (cm) *</label>
                <input type="number" id="altezza" name="altezza" class="form-control" [(ngModel)]="nuovoCliente.altezza"
                  min="0" placeholder="175">
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="numAllenamentiSett">Allenamenti Settimanali</label>
                <input type="text" id="numAllenamentiSett" name="numAllenamentiSett" class="form-control"
                  [(ngModel)]="nuovoCliente.numAllenamentiSett" placeholder="3-4 volte">
              </div>
            </div>
          </div>
          }

          <!-- Stile di Vita -->
          @if (step === 4) {
          <div class="form-section">
            <h3><fa-icon [icon]="faUserPlus"></fa-icon> Stile di Vita</h3>

            <div class="form-row">
              <div class="form-group">
                <label for="quantitaEQualitaDelSonno">Qualità del Sonno</label>
                <textarea id="quantitaEQualitaDelSonno" name="quantitaEQualitaDelSonno" class="form-control"
                  [(ngModel)]="nuovoCliente.quantitaEQualitaDelSonno"
                  placeholder="Ore di sonno, qualità, etc..."></textarea>
              </div>

              <div class="form-group checkbox-group">
                <label class="checkbox-label">
                  <input type="checkbox" id="beveAlcol" name="beveAlcol" [(ngModel)]="nuovoCliente.beveAlcol">
                  Consuma Alcolici
                </label>
              </div>
            </div>
          </div>
          }


          <!-- Informazioni Mediche -->
          @if (step === 5) {
          <div class="form-section">
            <h3><fa-icon [icon]="faNotesMedical"></fa-icon> Informazioni Mediche</h3>

            <div class="form-row">
              <div class="form-group">
                <label for="intolleranze">Intolleranze Alimentari</label>
                <textarea id="intolleranze" name="intolleranze" class="form-control"
                  [(ngModel)]="nuovoCliente.intolleranze" placeholder="Lattosio, glutine, etc..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="funzioniIntestinali">Funzioni Intestinali</label>
                <textarea id="funzioniIntestinali" name="funzioniIntestinali" class="form-control"
                  [(ngModel)]="nuovoCliente.funzioniIntestinali" placeholder="Regolari, irregolari, etc..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="problematicheSalutari">Problematiche Salutari</label>
                <textarea id="problematicheSalutari" name="problematicheSalutari" class="form-control"
                  [(ngModel)]="nuovoCliente.problematicheSalutari"
                  placeholder="Diabete, pressione alta, etc..."></textarea>
              </div>
            </div>

            <div class="form-row">
              <div class="form-group">
                <label for="assunzioneFarmaci">Assunzione Farmaci</label>
                <textarea id="assunzioneFarmaci" name="assunzioneFarmaci" class="form-control"
                  [(ngModel)]="nuovoCliente.assunzioneFarmaci" placeholder="Farmaci assunti regolarmente..."></textarea>
              </div>
            </div>
          </div>
          }


          <!-- Footer -->
          <div class="modal-footer">

            <button type="button" class="btn btn-secondary" (click)="chiudiModal()">
              <fa-icon [icon]="faTimes"></fa-icon>
              Annulla
            </button>

            <button type="button" class="btn btn-warning" (click)="vaiIndietro()" [disabled]="step === 1">
              <fa-icon [icon]="faChevronLeft"></fa-icon>
              Indietro
            </button>

            @if (step < maxStep) { <button type="button" class="btn btn-primary" (click)="vaiAvanti()">
              Avanti
              <fa-icon [icon]="faChevronRight"></fa-icon>
              </button>
              }

              @if (step === maxStep) {
              <button type="submit" class="btn btn-primary">
                <fa-icon [icon]="faSave"></fa-icon>
                {{ isEdit ? 'Salva' : 'Crea' }}
              </button>
              }

          </div>

        </form>
      </div>
    </div>
    }

  </main>
</div>